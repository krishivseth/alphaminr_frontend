<!-- templates/editor.html -->
{% extends "base.html" %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/tinymce@6/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
      tinymce.init({
        selector: 'textarea#editor',
        plugins: 'preview importcss searchreplace autolink autosave save directionality code visualblocks visualchars fullscreen link pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap quickbars emoticons fullpage noneditable',
        menubar: 'edit view insert format tools table help',
        toolbar: 'undo redo | bold italic underline strikethrough | fontfamily fontsize blocks | alignleft aligncenter alignright alignjustify | outdent indent |  numlist bullist | forecolor backcolor removeformat | pagebreak | charmap emoticons | fullscreen  preview save print | link anchor',
        autosave_ask_before_unload: true,
        autosave_interval: '30s',
        autosave_prefix: '{path}{query}-{id}-',
        autosave_restore_when_empty: false,
        autosave_retention: '2m',
        image_advtab: true,
        height: 'calc(100vh - 250px)',
        content_css: '/static/css/newsletter.css',
        noneditable_class: 'mceNonEditable',
        setup: function (editor) {
            editor.on('change', function () {
                tinymce.triggerSave();
            });
        }
      });
    </script>
<style>
    .editor-container {
        height: calc(100vh - 200px);
    }
    .editor-panel {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        padding: 20px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="toolbar">
    <h2>Edit Newsletter</h2>
    <div class="btn-group" role="group">
        <button class="btn btn-success" onclick="saveNewsletter()">
            <i class="fas fa-save"></i> Save
        </button>
        <button class="btn btn-info" onclick="aiReview()">
            <i class="fas fa-robot"></i> AI Review
        </button>
        <button class="btn btn-warning" onclick="sendTest()">
            <i class="fas fa-paper-plane"></i> Send Test
        </button>
        <button class="btn btn-danger" onclick="sendToSubscribers()">
            <i class="fas fa-broadcast-tower"></i> Send to Subscribers
        </button>
    </div>
</div>

<div class="editor-container">
    <div class="editor-panel">
        <h5>Content Editor</h5>
        <textarea id="editor">{{ newsletter.html_content|safe }}</textarea>
    </div>
</div>

<!-- Editor Notes Modal -->
<div class="modal fade" id="notesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editor Notes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="editorNotes" rows="4" placeholder="Add notes about your edits..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveWithNotes()">Save with Notes</button>
            </div>
        </div>
    </div>
</div>

<!-- AI Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="reviewContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const newsletterId = "{{ newsletter.id }}";
    
    function saveNewsletter() {
        $('#notesModal').modal('show');
    }
    
    function saveWithNotes() {
        // The tinymce.triggerSave() in the setup ensures the textarea is updated
        const content = document.getElementById('editor').value;
        const notes = document.getElementById('editorNotes').value;
        
        fetch(`/api/newsletter/${newsletterId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                html_content: content,
                editor_notes: notes
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Newsletter saved successfully!');
                $('#notesModal').modal('hide');
            } else {
                alert('Error saving newsletter: ' + data.error);
            }
        });
    }
    
    function aiReview() {
        $('#reviewModal').modal('show');
        
        fetch(`/api/newsletter/${newsletterId}/review`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('reviewContent').innerHTML = `
                    <div class="alert alert-info">
                        <h6>AI Review Results:</h6>
                        <pre style="white-space: pre-wrap;">${data.review}</pre>
                    </div>
                `;
            } else {
                document.getElementById('reviewContent').innerHTML = `
                    <div class="alert alert-danger">
                        Error: ${data.error}
                    </div>
                `;
            }
        });
    }
    
    function sendTest() {
        if (confirm('Send a test email to the editor?')) {
            fetch(`/api/newsletter/${newsletterId}/send`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    test_mode: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Test email sent successfully!');
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }
    }
    
    function sendToSubscribers() {
        if (confirm('Are you sure you want to send this newsletter to all subscribers? This action cannot be undone.')) {
            fetch(`/api/newsletter/${newsletterId}/send`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    test_mode: false
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Newsletter sent to all subscribers!');
                    window.location.href = '/';
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }
    }
</script>
{% endblock %}